<!DOCTYPE html>
<html>
<head>
    <title>DC Metro Map LED Display</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f0f0f0;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .controls {
            margin: 20px 0;
            padding: 20px;
            background: #f8f8f8;
            border-radius: 4px;
        }
        .led-strip {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin: 20px 0;
        }
        .station {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 5px;
            border-radius: 4px;
            transition: background-color 0.3s;
        }
        .station:hover {
            background: #f8f8f8;
        }
        .led {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #ddd;
            display: inline-block;
            transition: all 0.3s ease;
        }
        .led.active {
            animation: glow 2s infinite;
        }
        .led.pulse {
            animation: pulse 1s infinite;
        }
        @keyframes glow {
            0% { box-shadow: 0 0 5px rgba(255,255,255,0.8); }
            50% { box-shadow: 0 0 15px rgba(255,255,255,0.8); }
            100% { box-shadow: 0 0 5px rgba(255,255,255,0.8); }
        }
        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.8; }
            100% { transform: scale(1); opacity: 1; }
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 4px;
            background: #0066cc;
            color: white;
            cursor: pointer;
        }
        button:hover {
            background: #0052a3;
        }
        .status {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
        }
        .status.running {
            background: #d4edda;
            color: #155724;
        }
        .status.stopped {
            background: #f8d7da;
            color: #721c24;
        }
        .station-name {
            flex: 1;
        }
        .station-code {
            color: #666;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>DC Metro Map LED Display</h1>
        
        <div class="controls">
            <button onclick="startUpdates()">Start Updates</button>
            <button onclick="stopUpdates()">Stop Updates</button>
            <div id="status" class="status">Checking status...</div>
        </div>

        <div class="led-strip" id="ledStrip">
            <!-- Will be populated by JavaScript -->
        </div>
    </div>

    <script>
        const stationData = {{station_data|tojson}};
        const lineColors = {{line_colors|tojson}};
        
        function createLEDStrip() {
            const strip = document.getElementById('ledStrip');
            Object.entries(stationData).forEach(([code, data]) => {
                const station = document.createElement('div');
                station.className = 'station';
                
                const led = document.createElement('div');
                led.className = 'led';
                led.id = `led-${data.index}`;
                
                const nameDiv = document.createElement('div');
                nameDiv.className = 'station-name';
                nameDiv.textContent = data.name;
                
                const codeDiv = document.createElement('div');
                codeDiv.className = 'station-code';
                codeDiv.textContent = code;
                
                station.appendChild(led);
                station.appendChild(nameDiv);
                station.appendChild(codeDiv);
                strip.appendChild(station);
            });
        }

        async function updateStatus() {
            try {
                const response = await fetch('/api/status');
                const data = await response.json();
                const status = document.getElementById('status');
                status.textContent = `Status: ${data.auto_updates ? 'Running' : 'Stopped'} (LED Controller: ${data.led_initialized ? 'Initialized' : 'Not Initialized'})`;
                status.className = `status ${data.auto_updates ? 'running' : 'stopped'}`;
            } catch (error) {
                console.error('Error updating status:', error);
            }
        }

        async function startUpdates() {
            try {
                await fetch('/start_updates', { method: 'POST' });
                updateStatus();
            } catch (error) {
                console.error('Error starting updates:', error);
            }
        }

        async function stopUpdates() {
            try {
                await fetch('/stop_updates', { method: 'POST' });
                updateStatus();
                // Clear all LEDs in the display
                document.querySelectorAll('.led').forEach(led => {
                    led.style.backgroundColor = '#ddd';
                    led.style.boxShadow = 'none';
                    led.classList.remove('active');
                });
            } catch (error) {
                console.error('Error stopping updates:', error);
            }
        }

        // Update LED display
        async function updateLEDs() {
            try {
                const response = await fetch('/led_status');
                const data = await response.json();
                
                // Reset all LEDs
                document.querySelectorAll('.led').forEach(led => {
                    led.style.backgroundColor = '#ddd';
                    led.style.boxShadow = 'none';
                    led.classList.remove('active');
                });
                
                // Update active LEDs with effects
                data.leds.forEach(led => {
                    const ledElement = document.getElementById(`led-${led.index}`);
                    if (ledElement) {
                        const [r, g, b] = led.color;
                        const brightness = led.brightness || 1.0;
                        const alpha = Math.max(0.2, brightness);
                        ledElement.style.backgroundColor = `rgba(${r},${g},${b},${alpha})`;
                        ledElement.classList.add('active');
                        
                        // Add pulse effect for multiple trains
                        if (led.pulse) {
                            ledElement.classList.add('pulse');
                        } else {
                            ledElement.classList.remove('pulse');
                            // Add glow effect for single train
                            const glowStrength = brightness * 10;
                            ledElement.style.boxShadow = `0 0 ${glowStrength}px rgba(${r},${g},${b},${brightness})`;
                        }
                    }
                });
            } catch (error) {
                console.error('Error updating LEDs:', error);
            }
        }

        // Initialize
        createLEDStrip();
        updateStatus();
        
        // Poll for updates every second
        setInterval(() => {
            updateStatus();
            updateLEDs();
        }, 1000);
    </script>
</body>
</html>
